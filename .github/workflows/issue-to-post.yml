name: Convert Issue to Post

on:
    issues:
        types: [labeled]

jobs:
    create-post:
        if: github.event.label.name == 'publish'
        runs-on: ubuntu-latest
        permissions:
            contents: write
            issues: write
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Create Post from Issue
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const path = require('path');

                      const issue = context.payload.issue;
                      const title = issue.title;
                      const body = issue.body;
                      const date = new Date().toISOString().split('T')[0];
                      const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');

                      const content = \`---
                      title: "\${title}"
                      date: "\${date}"
                      description: "Imported from GitHub Issue #\${issue.number}"
                      tags: ["issue", "imported"]
                      slug: "\${slug}"
                      author: "\${issue.user.login}"
                      ---

                      \${body}
                      \`;

                      const filepath = path.join('content/posts', \`\${slug}.md\`);
                      fs.writeFileSync(filepath, content);

            - name: Commit New Post
              uses: stefanzweifel/git-auto-commit-action@v5
              with:
                  commit_message: "feat: add post from issue #${{ github.event.issue.number }}"
                  file_pattern: content/posts/*.md

            - name: Close Issue
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.issues.update({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.issue.number,
                        state: 'closed'
                      })
